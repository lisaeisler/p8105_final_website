---
title: "Exploratory Data Analysis"
output: html_document
---

```{r setup, warning=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(haven)
library(plotly)
library(viridis)
library(patchwork)
library(kableExtra)
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
#Data Import#
nsqipspineCP_1617 = read_csv("./data/nsqipspineCP_1617.csv")
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
#Data cleaning and tidying
cp_spine_tidy = nsqipspineCP_1617 %>%
  mutate_if(is.numeric, ~replace(., . == -99, NA)) %>%
  mutate(
    age_years = age_days/365.25,
    height = height*2.54,
    weight = weight/2.2) %>%
  mutate(
    bmi = weight/((height/100)*(height/100)),
    asa_status = case_when(
      asaclas == "ASA 1 - No Disturb" ~ "1",
      asaclas == "ASA 2 - Mild Disturb" ~ "2",
      asaclas == "ASA 3 - Severe Disturb" ~ "3",
      asaclas == "ASA 4 - Life Threat" ~ "4",
      asaclas == "None assigned" ~ "NA"),
    home_discharge = case_when(
      dischdest == "Expired" ~ "FALSE",
      dischdest == "Facility Which was Home" ~ "TRUE",
      dischdest == "Home" ~ "TRUE",
      dischdest == "Rehab" ~ "FALSE",
      dischdest == "Separate Acute Care" ~ "FALSE",
      dischdest == "Skilled Care, Not Home" ~ "FALSE",
      dischdest == "Unknown" ~ "NA",
      dischdest == "Unskilled Facility Not Home" ~ "FALSE",
      dischdest == "NULL" ~ "NA"),
    level_13 = case_when(
      prncptx == "ARTHRODESIS, ANTERIOR, FOR SPINAL DEFORMITY, WITH OR WITHOUT CAST; 2 TO 3 VERTEBRAL SEGMENTS" ~ "FALSE",
      prncptx == "ARTHRODESIS, ANTERIOR, FOR SPINAL DEFORMITY, WITH OR WITHOUT CAST; 4 TO 7 VERTEBRAL SEGMENTS" ~ "FALSE",
      prncptx == "ARTHRODESIS, ANTERIOR, FOR SPINAL DEFORMITY, WITH OR WITHOUT CAST; 8 OR MORE VERTEBRAL SEGMENTS" ~ "FALSE",
      prncptx == "ARTHRODESIS, POSTERIOR, FOR SPINAL DEFORMITY, WITH OR WITHOUT CAST; UP TO 6 VERTEBRAL SEGMENTS" ~ "FALSE",
      prncptx == "ARTHRODESIS, POSTERIOR, FOR SPINAL DEFORMITY, WITH OR WITHOUT CAST; 7 TO 12 VERTEBRAL SEGMENTS" ~ "FALSE",
      prncptx == "ARTHRODESIS, POSTERIOR, FOR SPINAL DEFORMITY, WITH OR WITHOUT CAST; 13 OR MORE VERTEBRAL SEGMENTS" ~ "TRUE")) %>%
  filter(home_discharge != "NA") %>% 
  select(pufyear_x:ped_spn_post_neurodeftype, age_years, sex, height, weight, bmi, ethnicity_hispanic, race, asa_status, transt, ventilat, asthma, hxcld, oxygen_sup, crf, impcogstat, seizure, nutr_support, hemodisorder, level_13, optime, tothlos, d_opto_dis, death30yn, supinfec, wndinfd, orgspcssi, dehis, oupneumo, pulembol, renainsf, urninfec, cszre, neurodef, cdarrest, othbleed, bleed_ml_tot, othcdiff, othsysep, unplannedreadmission1, reoperation, dischdest, home_discharge)
```

## Variables
The NSQIP pediatric spine dataset contains pre-operative, intra-operative, and post-operative variables for over 800 patients with cerebral palsy undergoing spinal fusion surgery. After data cleaning, we selected variables of interest that could help identify risk factors for post-operative discharge to a location other than home, such as to a rehabilitation facility, or to an acute care or skilled nursing care facility. 

The baseline patient charateristic variables include (but are not limited to): demographic data (age, BMI, race and ethnicity) and medical history (asthma, chronic lung disease, developmental delay, seizures). The intraoperative variables inlcude (but are not limited to): number of spinal levels operated on, operation length of time, bleeding/transfusions. The post-operative outcomes include (but are not limited to) length of stay, death within 30 days, infections, unplanned readmissions, and the outcome we are specifically interested in, location of discharge.

For a full variable list and description, please see the full report. After data cleaning, we had a dataset with 822 observations and 57 variables total.

## Demographic Information
The average age of male and female patients is summarized below:
```{r, echo=FALSE, message=FALSE, warning=FALSE}
cp_spine_tidy %>%
  group_by(sex) %>% 
  summarize(mean_age = mean(age_years), sd = sd(age_years)) %>% 
  rename(Sex = sex, "Average Age (Years)" = mean_age, "Standard Deviation" = sd) %>% 
  knitr::kable(digits = 2) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = F,
                position = "left")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
cp_spine_tidy %>%
  plot_ly(y = ~age_years, color = ~sex, type = "box") %>% 
  layout(
    autosize = F, width = 400, height = 250,
    xaxis = list(title = " "),
    yaxis = list(title = "Average Age (Years)"))
```

The following plots show the distribution of race and ethnicity in the dataset.